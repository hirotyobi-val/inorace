<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>いのレース</title>
    <style type="text/css">
      td.value {
        text-align: right;
      }
    </style>
    <script src="http://cdn.rawgit.com/phi-jp/tmlib.js/0.3.0/build/tmlib.js"></script>
    <script>
        turn = 0;
        <% turn = 0%>
        tm.main(function() {
          // キャンバスアプリケーションを生成
          var app = tm.display.CanvasApp("#course");
          // リサイズ
          app.resize(<%= @race.get_course.distance+100 %>/15, <%= @race.get_runners.length*50 %>);
          // ウィンドウにフィットさせる
          app.fitWindow();

          // ターン毎の位置を2次元配列に格納
          turns = new Array(<%= @race.get_turns.length %>);
          for (t=0; t<turns.length; t++){
            turns[t] = new Array(<%= @race.get_runners.length %>);
          }
          <% for t in 0..@race.get_turns.length-1 %>
            <% for i in 0..@race.get_runners.length-1 %>
              turns[<%= t %>][<%= i %>] = <%= @race.get_turn_positions[t][i] %>;
            <% end %>
          <% end %>

          // シーンを生成&入れ替え
          var scene = MainScene();
          app.replaceScene(scene);

          // 実行
          app.run();
        });

        // シーンを定義
        tm.define("MainScene", {
            superClass: "tm.app.Scene",
            
            init: function() {
              this.superInit();

              <% for i in 0..@race.get_runners.length-1 %>
              <% runner = @race.get_runners[i] %>
                this.star<%= runner.id %> = tm.display.StarShape().addChildTo(this);
                this.star<%= runner.id %>.setPosition(0, 50*<%= runner.id %>-25);
              <% end %>
            },
            
            update: function(app) {
              // 更新処理
              if (turn < <%= @race.get_turns.length %>){
                <% for i in 0..@race.get_runners.length-1 %>
                  <% runner = @race.get_runners[i] %>
                  this.star<%= runner.id %>.x = turns[turn][<%= i %>]/15
                  this.star<%= runner.id %>.rotation = turns[turn][<%= i %>]/15
                <% end %>
                turn += 1;
                <% turn += 1 %>
              }
            }
        });

    </script>
  </head>
  <body>

    <div class="put_distance">
      レース距離：<%= @race.get_course.distance %>
    </div>

    <div class="put_runnners">
      <table border>
        <tr>
          <td>
          </td>
          <td>
            スピード
          </td>
          <td>
            安定感
          </td>
        </tr>
        <% for i in 0..@race.get_runners.length-1 %>
          <% runner = @race.get_runners[i] %>
          <tr>
            <td>
              <%= runner.id %> 
            </td>
            <td class="value">
              <%= runner.speed %> 
            </td>
            <td class="value">
              <%= runner.stable %> 
            </td>
          </tr>
        <% end %>
      </table>
    </div>

    <div class="canvas">
      <canvas id="course"></canvas>
    </div>

    <div class="result_rank_1">
      1位:
      <%= @race.get_rank_ordered_runner_ids[0] %>
    </div>
    <div class="result_rank_2">
      2位:
      <%= @race.get_rank_ordered_runner_ids[1] %>
    </div>

  </body>
</html>
